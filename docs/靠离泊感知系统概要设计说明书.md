# 靠离泊感知系统概要设计说明书

| 版本 | 日期 | 作者 | 修订说明 |
|------|------|------|----------|
| v1.0 | 2025-12-31 | nga | 初稿，完成系统架构与模块设计 |

---

## 目录
1. [引言](#1-引言)
2. [总体设计](#2-总体设计)
3. [详细模块设计](#3-详细模块设计)
4. [数据结构与接口设计](#4-数据结构与接口设计)
5. [运行环境](#5-运行环境)
6. [附录](#6-附录)

---

## 1. 引言

### 1.1 编写目的
本文档旨在描述 LingerPerceiver 靠离泊感知系统的总体架构、模块划分、接口设计及关键数据流程，为后续的详细设计、代码实现及系统维护提供指导。

### 1.2 项目背景
无人艇在靠离泊过程中需要高精度的环境感知能力，以实时获取船体相对于码头的距离、角度及周围障碍物信息。本系统基于 Livox 激光雷达，通过点云处理算法提取岸线特征，并通过 UDP 协议将感知结果发送给控制系统。

### 1.3 系统目标
- **实时性**：提供低延迟的距离与角度输出（目标 10-20Hz）。
- **准确性**：在复杂水面环境下准确识别码头岸线，滤除海面与噪声。
- **灵活性**：支持多种码头形状（直线、L型、U型）及多雷达布局。
- **可靠性**：具备长时间稳定运行能力（Headless 模式），支持异常检测与状态上报。
- **可调试性**：提供完整的数据录制、回放及可视化调试工具。

---

## 2. 总体设计

### 2.1 系统架构
系统采用分层架构设计，自下而上分为基础设施层、设备层、处理层、算法层与应用层。各层之间通过明确定义的接口进行交互，确保了系统的低耦合与高可扩展性。

**图例说明**：
- **垂直箭头（`|` 或 `v`）**：表示数据流向或依赖方向，从下层到上层，或从一个模块到另一个模块。
- **横向箭头（`->` 或 `--`）**：表示同一层内模块之间的调用或数据传递。
- **双向箭头（`<-->`）**：表示双向交互，如 `DeviceManager` 与 `Replayer` 之间的录制/回放协作。

**数据流方向**：从底部的硬件设备向上流动，经设备层采集、处理层滤波、算法层分析，最终由通信层输出给控制系统或应用层展示。

```text
+---------------------------------------------------------------+
|                      应用层 (Application)                     |
|  +-----------------------+       +-------------------------+  |
|  |  GUI Application (Qt) |       | Headless Service (CLI)  |  |
|  +-----------+-----------+       +------------+------------+  |
|              |                                |               |
+--------------|--------------------------------|---------------+
               v (渲染请求/状态订阅)            v (日志输出)
+---------------------------------------------------------------+
|                      通信层 (Communication)                   |
|           +---------------------------------------+           |
|           |           DockingPublisher            |           |
|           |      (UDP Protocol / Heartbeat)       |           |
|           +-------------------+-------------------+           |
+-------------------------------^-------------------------------+
                                | (DockingState)
+-------------------------------|-------------------------------+
|                      算法层 (Algorithm)                       |
|  +---------------------------------------------------------+  |
|  |                    DockingAlgorithm                     |  |
|  | +----------------+  +----------------+  +-------------+ |  |
|  | | Nearest Region |  | Dock Edge (V1) |  | State Fusion| |  |
|  | +----------------+  +----------------+  +-------------+ |  |
|  +----------------------------^----------------------------+  |
+-------------------------------|-------------------------------+
                                | (Filtered PointCloud)
+-------------------------------|-------------------------------+
|                      处理层 (Processing)                      |
|  +---------------------+    +------------------------------+  |
|  | PointCloudProcessor | -> |       Filter Pipeline        |  |
|  +---------------------+    | (ROI/Sea/Voxel/Outlier/...)  |  |
|                             +------------------------------+  |
+-------------------------------^-------------------------------+
                                | (Raw PointCloud + Pose)
+-------------------------------|-------------------------------+
|                       设备层 (Device)                         |
|  +----------------+      +----------------+  +-------------+  |
|  | DeviceManager  | <--> |    Replayer    |--|   Streamer  |  |
|  +-------+--------+      +----------------+  +-------------+  |
|          |                (录制/回放协作)     (文件读写)       |
+----------|----------------------------------------------------+
           v (Livox Packets)
+---------------------------------------------------------------+
|                    基础设施层 (Infrastructure)                |
|  +--------------+    +--------------+    +-----------------+  |
|  |  Livox SDK2  |    |  PCL / Eigen |    |  Qt / VTK / OS  |  |
|  +--------------+    +--------------+    +-----------------+  |
+---------------------------------------------------------------+
```

### 2.2 部署方案
- **多进程多实例**：针对“一船多雷达”场景，采用多进程部署方案。每个雷达对应一个独立的 `linger_perceiver` 进程，通过配置文件区分角色（前向/左舷/右舷）。
- **Headless 模式**：生产环境使用无界面服务模式运行，降低资源消耗，通过日志与 UDP 心跳监控状态。
- **GUI 模式**：开发与调试阶段使用带界面的应用程序，提供点云可视化、参数调整与回放控制。

### 2.3 数据流图
下图展示了从雷达采集到 UDP 输出的端到端数据流：

```text
                              【实时采集模式】
┌─────────────┐
│ Livox LiDAR │
└──────┬──────┘
       │ SDK回调线程 (点云/IMU)
       v
┌──────────────────────────────────────────────────────────────────────┐
│                         DeviceManager                                │
│  ┌─────────────┐    ┌──────────────┐    ┌──────────────────────┐    │
│  │enqueuePacket│───>│ frame_queue_ │───>│ frameDispatcher_线程 │    │
│  │ (快速入队)   │    │  (SPSC队列)  │    │ (解析+配Pose+分发)   │    │
│  └─────────────┘    └──────────────┘    └──────────┬───────────┘    │
│                                                     │                │
│                     ┌───────────────────────────────┤                │
│                     v                               v                │
│            ┌────────────────┐             ┌─────────────────┐        │
│            │ DataProcessor  │             │    Replayer     │        │
│            │ (IMU/时间同步)  │             │  (写入.lgv文件)  │        │
│            └────────────────┘             └─────────────────┘        │
└─────────────────────────────────┬────────────────────────────────────┘
                                  │ onFrameWithPose(cloud, pose)
                                  v
┌──────────────────────────────────────────────────────────────────────┐
│                      PointCloudProcessor                             │
│  ┌─────────────┐    ┌──────────────┐    ┌──────────────────────┐    │
│  │   enqueue   │───>│    queue_    │───>│    worker_ 线程      │    │
│  │  (快速入队)  │    │  (SPSC队列)  │    │  (执行滤波器链)      │    │
│  └─────────────┘    └──────────────┘    └──────────┬───────────┘    │
│                                                     │                │
│   滤波器链: Distance → CropBox → SeaSurface → Voxel → Outlier → ... │
└─────────────────────────────────┬────────────────────────────────────┘
                                  │ mapUpdateCallback(clouds)
                    ┌─────────────┴─────────────┐
                    v                           v
          ┌─────────────────┐         ┌─────────────────┐
          │    Renderer     │         │ DockingAlgorithm│
          │ (VTK点云渲染)    │         │ (靠泊状态检测)   │
          └─────────────────┘         └────────┬────────┘
                                               │ onStateUpdated(state)
                                               v
                                    ┌─────────────────────┐
                                    │  DockingPublisher   │
                                    │  (UDP异步发送线程)   │
                                    └──────────┬──────────┘
                                               │ UDP Packet (20 bytes)
                                               v
                                    ┌─────────────────────┐
                                    │   Control System    │
                                    │    (无人艇控制)      │
                                    └─────────────────────┘

                              【回放模式】
┌─────────────┐    ┌─────────────┐    ┌───────────────────────────┐
│  .lgv 文件  │───>│   Replayer  │───>│ DeviceManager (回调注入)  │
│             │    │ worker线程   │    │                           │
└─────────────┘    └─────────────┘    └─────────────┬─────────────┘
                                                     │
                            (后续数据流与实时模式相同) v
```

### 2.4 线程模型
系统采用多线程架构，各模块职责明确，通过无锁队列和回调机制进行通信：

| 线程 | 归属模块 | 职责 | 同步机制 |
|------|----------|------|----------|
| **SDK 回调线程** (多个) | Livox SDK | 接收原始数据包 | `enqueuePacket()` 快速入队 |
| **frame_worker_** | DeviceManager | 解析点云、匹配 Pose、触发回调 | SPSC 无锁队列 |
| **processor_worker_** | PointCloudProcessor | 执行滤波器链、发布快照 | SPSC 无锁队列 + 条件变量 |
| **replay_worker_** | Replayer | 读取 .lgv 文件、模拟帧回调 | 条件变量控制暂停/倍速 |
| **sender_worker_** | DockingPublisher | 异步发送 UDP 数据包 | 条件变量 + 原子变量 |
| **render_worker_** | Renderer | VTK 点云转换与更新 | 原子指针交换 |
| **UI 主线程** | Qt | 事件循环、界面响应 | Qt 信号槽 |

**线程安全设计原则**：
- SDK 回调尽快返回，不做耗时操作
- 模块间通过无锁 SPSC 队列传递数据
- 共享状态使用 `std::atomic` 或 `std::mutex` 保护
- 回调函数应快速返回，避免阻塞上游线程

### 2.5 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **端到端延迟** | < 100ms | 从雷达采集到 UDP 输出 |
| **处理帧率** | 10-20 Hz | 与雷达输出帧率匹配 |
| **CPU 占用** | < 30% (单核) | Headless 模式下 |
| **内存占用** | < 500 MB | 稳定运行状态 |
| **丢帧率** | < 1% | 正常工况下 |
| **启动时间** | < 5s | 从进程启动到首帧输出 |
---

## 3. 详细模块设计

### 3.1 设备层

#### 3.1.1 DeviceManager
- **职责**：作为设备管理的 Facade，封装 Livox SDK2 的复杂性。
- **功能**：
  - 设备发现、连接与配置。
  - 原始数据包接收与点云帧构建。
  - 集成 `DataProcessor` 进行时间同步与 IMU 姿态解算。
  - 协调 `Replayer` 进行数据录制与回放。
- **接口**：提供 `onFrameWithPose` 回调，向下游推送带有时间戳和姿态的点云帧。

#### 3.1.2 Replayer & Streamer
- **职责**：负责数据的持久化与回放。
- **格式**：自定义 `.lgv` 格式（Magic: LGV1），存储压缩后的点云与姿态数据。
- **功能**：
  - **录制**：异步写入线程，避免阻塞采集主线程。
  - **回放**：支持倍速（0.5x-8x）、暂停、进度跳转（Seek）。

### 3.2 处理层

#### 3.2.1 PointCloudProcessor
- **职责**：点云处理流水线的调度核心。
- **机制**：维护输入帧队列，在工作线程中依次执行滤波器链。
- **功能**：
  - 线程安全的帧队列管理。
  - 动态加载/卸载滤波器。
  - 向 GUI 渲染器和算法模块分发处理后的点云快照。

#### 3.2.2 滤波器组
系统实现了一系列继承自 `Filter` 基类的功能模块，支持通过 JSON 配置动态启用/禁用：

1. **DistanceFilter**：基于距离阈值的直通滤波。
2. **CropBoxFilter**：基于 ROI（感兴趣区域）的裁剪，去除船体自身点云。
3. **SeaSurfaceFilter**：基于 Z 轴高度的海面滤除，保留岸线结构。
4. **StatisticalOutlierFilter**：统计离群点去除，消除空中噪点。
5. **VoxelFilter**：体素下采样，降低点云密度，提升后续算法效率。
6. **DensityFilter**：基于半径内邻居数量的密度滤波，去除稀疏噪声。
7. **MotionFilter**：基于时序差异的运动滤波，分离静态背景与动态障碍物。

### 3.3 算法层

#### 3.3.1 DockingAlgorithm
- **职责**：从处理后的点云中提取靠泊状态。
- **核心算法**：
  1. **最近区域检测 (Nearest Region)**：计算指定扇区内最近点的距离，作为安全冗余。
  2. **码头边缘检测 (Dock Edge)**：
     - 对点云进行 Z 轴切片。
     - 使用 RANSAC 算法拟合直线特征。
     - 计算直线到原点的距离与角度。
  3. **状态融合**：结合多种检测结果，输出综合置信度与状态码。

### 3.4 通信层

#### 3.4.1 DockingPublisher
- **职责**：将感知结果发送给外部控制系统。
- **协议**：UDP 协议，二进制数据包。
- **策略**：
  - 异步发送线程。
  - 超时保护：若长时间未检测到目标，发送状态为“无效”的安全包。

### 3.5 应用层

#### 3.5.1 GUI Application
- **技术栈**：Qt 5 + VTK 8/9。
- **功能**：
  - `PointCloudWgt`：封装 VTK 渲染窗口，显示点云、坐标轴、拟合直线及文本信息。
  - 参数面板：实时调整滤波器参数与算法阈值。
  - 录制/回放控制栏。

#### 3.5.2 Headless Service
- **功能**：仅包含核心处理逻辑的控制台程序。
- **特性**：
  - 支持命令行参数启动（指定配置文件、回放文件）。
  - 集成 `spdlog` 日志系统，支持按日期滚动存储。
  - 信号处理（Signal Handling）实现优雅退出。

### 3.6 错误处理与容错机制

#### 3.6.1 异常场景与处理策略
| 异常场景 | 检测方式 | 处理策略 |
|----------|----------|----------|
| **设备断连** | SDK 回调 `onDeviceStateChange` | 记录日志，触发 `onError` 回调，尝试重连 |
| **数据丢帧** | 时间戳间隔检测 | 记录警告日志，不影响后续处理 |
| **队列溢出** | SPSC 队列满检测 | 丢弃最旧帧，记录丢帧计数 |
| **算法超时** | 连续 N 帧无有效结果 | 输出 `status=NOT_DETECTED` 状态包 |
| **UDP 发送失败** | Socket 错误码 | 记录错误日志，下次重试 |
| **配置文件错误** | JSON 解析异常 | 使用默认配置，记录警告 |
| **内存不足** | `bad_alloc` 异常 | 清空缓存，记录错误日志 |

#### 3.6.2 日志与监控
- **日志级别**：DEBUG / INFO / WARN / ERROR
- **日志存储**：`log/<日期>/linger_*.log`，按大小滚动（5MB/文件，5 个文件）
- **关键日志点**：
  - 设备连接/断开
  - 采集启动/停止
  - 丢帧事件
  - 算法状态变化
  - UDP 发送统计

---

## 4. 数据结构与接口设计

### 4.1 核心数据流对象
- **PointCloudPtr**：`pcl::PointCloud<pcl::PointXYZI>::Ptr`，内部流转的基本数据单元。
- **Pose**：包含时间戳（ns）、四元数（Orientation）、陀螺仪读数。

### 4.2 关键接口定义

#### 4.2.1 DeviceManager 回调接口
```cpp
// 点云帧回调（下游模块实现）
std::function<void(PointCloudPtr cloud, const Pose& pose)> onFrameWithPose;

// 错误通知回调
std::function<void(const std::string& message)> onError;

// 信息通知回调
std::function<void(const std::string& message)> onInfo;
```

#### 4.2.2 PointCloudProcessor 接口
```cpp
// 帧入队（从 DeviceManager 调用）
void enqueue(PointCloudPtr pc, const Pose& pose);

// 注册快照更新回调（Renderer/DockingAlgorithm 调用）
void setMapUpdateCallback(
    std::function<void(const std::vector<PointCloudPtr>&, size_t)> cb);

// 添加滤波器
void addFilter(Linger::FilterPtr filter, bool is_post_process = false);
```

#### 4.2.3 DockingAlgorithm 接口
```cpp
// 处理多个点云块
DockingState processMultiple(
    const std::vector<PointCloudPtr>& clouds, 
    uint64_t timestamp_ns);

// 状态更新回调
std::function<void(const DockingState&)> onStateUpdated;

// 配置接口
void setConfig(const DockingConfig& config);
void setNearestConfig(const NearestRegionConfig& config);
void setEdgeConfig(const DockEdgeConfig& config);
```

#### 4.2.4 DockingPublisher 接口
```cpp
// 发布靠泊状态
void publish(const DockingState& state);

// 配置
void setConfig(const UdpConfig& config);

// 生命周期
void start();
void stop();
```

### 4.3 通信协议 (DockingPacket)
采用 1 字节对齐的小端二进制结构，总长 20 字节：

| 偏移 | 类型 | 名称 | 说明 |
| :--- | :--- | :--- | :--- |
| 0 | uint64_t | timestamp_ns | 系统时间戳（纳秒） |
| 8 | uint8_t | sensor_id | 雷达编号 (1=前, 2=左, 3=右) |
| 9 | uint8_t | status | 状态 (0=未检测, 1=正常, 2=低置信度) |
| 10 | uint8_t | confidence | 置信度 (0-100) |
| 11 | uint8_t | reserved | 保留 |
| 12 | float | distance_m | 垂直距离（米） |
| 16 | float | angle_deg | 边缘角度（度） |

### 4.4 配置文件 (app_config.json)
采用 JSON 格式管理全系统配置，主要包含：
- **filters**：各滤波器的启用状态及参数。
- **docking**：靠泊算法的扇区范围、RANSAC 阈值等。
- **udp**：目标 IP、端口及本机 Sensor ID。

**配置示例**：
```json
{
    "filters": {
        "distance": { "enabled": true, "min_m": 0.1, "max_m": 100.0 },
        "roi": { "enabled": true, "x_min": -10.0, "x_max": 50.0, ... },
        "sea_filter": { "enabled": true, "sea_level_z": -0.6, "margin_m": 0.1 },
        "voxel": { "enabled": true, "leaf_size": 0.1 }
    },
    "docking": {
        "nearest_region": { "enabled": true, "sector_x_max": 15.0, ... },
        "dock_edge": { "enabled": true, "ransac_dist": 0.15, ... }
    },
    "udp": { "target_ip": "127.0.0.1", "target_port": 5000, "sensor_id": 1 }
}
```

---

## 5. 运行环境

### 5.1 硬件环境
- **处理器**：Intel Core i5 或同级以上（建议 4 核以上）。
- **内存**：8GB 以上。
- **传感器**：Livox Mid-360 或同系列激光雷达。
- **网络**：千兆以太网（用于雷达连接与 UDP 通信）。

### 5.2 软件环境
- **操作系统**：Windows 10/11 (64-bit) 或 Linux (Ubuntu 20.04+)。
- **编译器**：MSVC 2017/2019/2022 或 GCC 9+。
- **依赖库**：
  - Qt 5.12+
  - VTK 8.2+
  - PCL 1.10+
  - Livox-SDK2
  - Eigen 3
  - spdlog
  - rapidjson

---

## 6. 附录

### 6.1 术语表

| 术语 | 英文全称 | 说明 |
|------|----------|------|
| **LiDAR** | Light Detection and Ranging | 激光雷达，通过激光测距获取环境三维信息 |
| **点云** | Point Cloud | 由大量三维点构成的数据集，每个点包含 x/y/z 坐标及强度 |
| **Pose** | - | 位姿，包含位置（平移）和姿态（旋转）信息 |
| **IMU** | Inertial Measurement Unit | 惯性测量单元，测量加速度和角速度 |
| **RANSAC** | Random Sample Consensus | 随机采样一致性算法，用于鲁棒的模型拟合 |
| **ROI** | Region of Interest | 感兴趣区域，用于裁剪点云范围 |
| **体素** | Voxel | 三维像素，用于点云下采样 |
| **SPSC** | Single Producer Single Consumer | 单生产者单消费者无锁队列 |
| **Facade** | - | 外观模式，提供统一的高层接口 |
| **Headless** | - | 无界面模式，不启动 GUI 的服务运行方式 |
| **UDP** | User Datagram Protocol | 用户数据报协议，无连接的传输层协议 |

### 6.2 参考文档
- [Livox SDK2 官方文档](https://github.com/Livox-SDK/Livox-SDK2)
- [PCL (Point Cloud Library) 文档](https://pointclouds.org/documentation/)
- [VTK 用户指南](https://vtk.org/documentation/)
- 《配置与通信协议说明.md》
- 《系统架构设计_v2.md》
- 《靠离泊感知系统开发计划2.0.md》

### 6.3 文件清单

| 目录 | 文件 | 说明 |
|------|------|------|
| `include/acquisition/` | `device_manager.h` | 设备管理 Facade |
| | `data_processor.h` | IMU/时间同步 |
| | `replayer.h`, `streamer.h` | 录制/回放 |
| `include/core/` | `processor.h` | 点云处理器 |
| | `common.h`, `config.h` | 公共类型与配置 |
| `include/preprocessing/` | `filter.h`, `*_filter.h` | 滤波器基类与实现 |
| `include/algorithms/` | `docking_algorithm.h` | 靠泊算法 |
| | `docking_types.h` | 算法数据类型 |
| `include/communication/` | `docking_publisher.h` | UDP 发布器 |
| | `docking_packet.h` | 通信协议定义 |
| `include/visualization/` | `renderer.h` | VTK 渲染器 |
| `include/ui/` | `point_cloud_wgt.h` | Qt 主窗口 |
| `src/` | `main.cpp` | GUI 入口 |
| | `main_headless.cpp` | Headless 入口 |
| `config/` | `app_config.json` | 应用配置文件 |
| `ui/` | `point_cloud_wgt.ui` | Qt UI 定义 |
