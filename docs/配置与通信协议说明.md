# 配置与通信协议说明

本说明文档用于规范无人艇靠离泊感知系统在多雷达多实例部署场景下的：

- 配置文件结构与字段含义；
- UDP 通信协议格式；
- 多船、多码头环境下的参数组织方式。

目标是使软件安装/运维人员与控制系统开发人员在不阅读源代码的前提下，也能正确配置与对接系统。

---

## 1. 配置文件总体设计

### 1.1 配置文件粒度

系统按照“**每个雷达实例一个配置文件**”的原则进行配置，示例：

- `config_front.json`：船首前向雷达实例；
- `config_port.json`：左舷雷达实例；
- `config_starboard.json`：右舷雷达实例。

每个配置文件描述：

- 与硬件相关的信息（雷达 IP、端口等）；
- 雷达在船体坐标系中的安装位置与朝向；
- 针对该雷达的预处理参数（ROI、海面高度、滤波参数等）；
- 通信参数（UDP 目标 IP/端口、`sensor_id` 等）；
- 码头环境与算法参数（如直线/L/U 型、RANSAC 阈值等）。

### 1.2 JSON 配置示例

```json
{
  "ship_id": "boat_001",
  "sensor_id": 1,
  "sensor_role": "front",  

  "lidar": {
    "ip": "192.168.1.10",
    "port": 55000
  },

  "mount": {
    "frame": "boat",           
    "x_m": 2.5,
    "y_m": 0.0,
    "z_m": 3.2,
    "yaw_deg": 0.0,             
    "pitch_deg": 0.0,
    "roll_deg": 0.0
  },

  "sea_filter": {
    "sea_level_z_m": 0.0,       
    "margin_m": 0.5
  },

  "roi": {
    "x_min_m": 0.0,
    "x_max_m": 50.0,
    "y_min_m": -20.0,
    "y_max_m": 20.0,
    "z_min_m": -2.0,
    "z_max_m": 10.0
  },

  "filters": {
    "distance": {
      "enabled": true,
      "min_m": 0.5,
      "max_m": 80.0
    },
    "voxel": {
      "enabled": true,
      "leaf_size_m": 0.1
    },
    "statistical_outlier": {
      "enabled": true,
      "mean_k": 50,
      "std_dev_mul": 1.0
    }
  },

  "docking_algorithm": {
    "mode": "front_docking",     
    "dock_type": "straight",      
    "open_direction_deg": 0.0,     

    "ransac": {
      "distance_threshold_m": 0.1,
      "max_iterations": 100,
      "min_inliers": 50
    },

    "sectors": {
      "front": {
        "azimuth_min_deg": -60.0,
        "azimuth_max_deg": 60.0
      },
      "port": {
        "azimuth_min_deg": 60.0,
        "azimuth_max_deg": 150.0
      },
      "starboard": {
        "azimuth_min_deg": -150.0,
        "azimuth_max_deg": -60.0
      }
    }
  },

  "udp": {
    "target_ip": "192.168.1.100",  
    "target_port": 60000,
    "send_interval_ms": 50,
    "timeout_ms": 500
  },

  "logging": {
    "log_file": "log_front.txt",
    "log_level": "info"
  }
}
```

---

## 2. 配置字段说明

### 2.1 顶层字段

- `ship_id`：字符串，船只编号，用于记录与区分不同船型；
- `sensor_id`：整型，雷达实例编号，在通信协议中直接使用；
- `sensor_role`：字符串，雷达角色标识，例如 `front`/`port`/`starboard`，主要用于日志与可读性。

### 2.2 `lidar` 段

- `ip` / `port`：
  - Livox 雷达所在的 IP 与端口（按实际网络配置填写）；

### 2.3 `mount` 段（雷达-船体外参）

- `frame`：坐标系名称，当前固定为 `boat`；
- `x_m`, `y_m`, `z_m`：雷达中心在船体坐标系 B 下的位置（单位：米）；
- `yaw_deg`, `pitch_deg`, `roll_deg`：雷达相对于 B 坐标系的欧拉角（度）。

> 实现上可先只使用 yaw_deg，pitch/roll 留作扩展。

### 2.4 `sea_filter` 段

- `sea_level_z_m`：在船体坐标系下的海面高度（一般可设为 0）；
- `margin_m`：海面上方保留的高度裕度（米）。

### 2.5 `roi` 段

- `x_min_m` ~ `x_max_m`：沿船体 X 轴方向的保留范围；
- `y_min_m` ~ `y_max_m`：沿船体 Y 轴（左右向）方向的保留范围；
- `z_min_m` ~ `z_max_m`：沿船体 Z 轴方向的保留范围。

### 2.6 `filters` 段

- `distance`：距离滤波器参数；
- `voxel`：体素滤波器参数；
- `statistical_outlier`：统计离群点去除参数。

各字段分别对应 `DistanceFilter`、`VoxelFilter`、`StatisticalOutlierFilter` 等模块。

### 2.7 `docking_algorithm` 段

- `mode`：当前靠泊模式（**一船多雷达方案下，通常每个实例固定选择一个模式，对应“只看自己那一侧的岸线”**）：
  - `front_docking`：使用前向扇区岸线；
  - `side_docking_port`：使用左舷扇区岸线；
  - `side_docking_starboard`：使用右舷扇区岸线；
- `dock_type`：码头类型：`straight`/`L`/`U` 等，当前实现以 `straight` 为主，其他类型为预留；
- `open_direction_deg`：U 型或 L 型码头开口大致方向（以船体或世界坐标系为参考），当前可留作扩展参数；
- `ransac` 段：岸线拟合算法参数；
- `sectors` 段：各扇区对应的方位角范围（度），用于后续 V2 多扇区模式预留；在当前多雷达部署方案中，通常只需要为每个实例配置其“负责扇区”的范围即可。

### 2.8 `udp` 段

- `target_ip` / `target_port`：控制系统的 IP 与端口；
- `send_interval_ms`：最小发送间隔（毫秒），用于限频；
- `timeout_ms`：超时阈值（毫秒），在该时间内无有效岸线时输出警告状态。

### 2.9 `logging` 段

- `log_file`：日志文件路径；
- `log_level`：日志级别（如 `debug`/`info`/`warn`/`error`）。

---

## 3. UDP 通信协议

### 3.1 数据包结构

使用紧凑的 C 结构体表示数据包，采用小端字节序：

```cpp
#pragma pack(push, 1)
struct DockingPacket {
    uint64_t timestamp_ns;   // 0  : 8 字节，系统时间戳 (纳秒)
    uint8_t  sensor_id;      // 8  : 1 字节，雷达编号 (1=前, 2=左舷, 3=右舷)
    uint8_t  status;         // 9  : 1 字节，状态码
    uint8_t  confidence;     // 10 : 1 字节，置信度 0-100
    uint8_t  reserved;       // 11 : 1 字节，保留（对齐）
    float    distance_m;     // 12 : 4 字节，检测距离（米，雷达坐标系）
    float    angle_deg;      // 16 : 4 字节，边缘角度（度），无边缘时为0
};
#pragma pack(pop)

static_assert(sizeof(DockingPacket) == 20, "DockingPacket must be 20 bytes");
```

- **总长度**：20 字节；
- **对齐方式**：`#pragma pack(push, 1)` 保证无额外填充；
- **字节序**：假定运行环境为小端（x86/x64），控制系统需按小端解析。

> **设计说明**：当前版本不含雷达外参（`sensor_x/y/z/yaw`），坐标转换（雷达→船体）由控制系统负责。如需在协议中携带外参信息，可在后续版本中扩展。

### 3.2 字段语义

- `timestamp_ns`：
  - 统一时间戳，使用 `DataProcessor::syncTimestamp` 得到的系统时间（纳秒）；
  - 多实例/多雷达部署时各实例时间可直接对齐。

- `sensor_id`：
  - 对应配置文件中的 `sensor_id`，用于在控制侧区分多个雷达；
  - 预定义值：`1`=前向, `2`=左舷, `3`=右舷。

- `status`：
  - `0` (NOT_DETECTED)：未检测（例如当前无足够点云或处于初始化阶段）；
  - `1` (NORMAL)：正常（输出可直接用于控制）；
  - `2` (LOW_CONFIDENCE)：低置信度警告（检测到但不可靠）。

- `confidence`：
  - 检测置信度，0-100；
  - 根据 RANSAC 内点数量、残差等归一化计算。

- `distance_m`：
  - 检测到的最近距离（单位：米）；
  - 在雷达坐标系下计算，坐标转换由控制系统负责。

- `angle_deg`：
  - 边缘角度（度），仅在边缘检测有效时有意义；
  - 无边缘检测结果时为 0。

### 3.3 发送策略

- 发送频率由 `send_interval_ms` 控制，例如 50ms（20Hz）；
- 当 `DockingAlgorithm` 没有新的有效结果时：
  - 若未超时，可复用上一次结果并更新时间戳；
  - 若已超时（超过 `timeout_ms`），发送 `status = 2`、`confidence = 0` 的告警包。

---

## 4. 多船、多码头环境下的参数组织

### 4.1 按船型组织配置

- 建议为每种船型维护一个配置目录，如：

```text
configs/
  boat_001/
    config_front.json
    config_port.json
    config_starboard.json
  boat_002/
    config_front.json
    ...
```

- 每个目录下的文件描述该船型下不同雷达的安装外参与处理参数。

### 4.2 按码头环境组织参数

- 在配置中为 `docking_algorithm.dock_type` 与其他环境相关参数预留字段：
  - `dock_type`: `straight` / `L` / `U`；
  - `open_direction_deg`: U 型开口方向；
  - 扇区配置：不同码头可使用不同的 `sectors` 范围。

- 可选策略：
  - 为每种典型码头场景定义一套“环境预设”，在执行任务前选择加载。

### 4.3 版本与回溯

- 建议在配置中加入版本号与备注信息：

```json
{
  "version": "1.0.0",
  "comment": "boat_001 front sensor config for straight dock A",
  ...
}
```

- 配合 Git 或其他版本管理工具，对配置变更进行记录与回溯。

---

## 5. 控制系统对接建议

1. **解析 DockingPacket** 时务必按照本文给出的字节布局和小端格式进行；
2. 对接初期可通过抓包工具（如 Wireshark）或简易测试程序验证：
   - 时间戳是否单调递增；
   - 距离/角度数值是否与 UI 显示一致；
3. 如需基于多雷达做高级融合，可利用：
   - 各实例的 `sensor_id` 与 `sensor_x/y/z`、`sensor_yaw_deg`；
   - 时间戳对齐，在控制段根据任务策略进行融合或加权决策。

---

本说明作为当前版本的配置与通信协议基线，后续如增加新字段或升级协议版本，应在文档中明确说明兼容性策略与迁移步骤。