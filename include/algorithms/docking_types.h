#pragma once

#include <cstdint>
#include <vector>

namespace Linger {

/**
 * @brief æ£€æµ‹çŠ¶æ€ç 
 */
enum class DockingStatus : uint8_t {
    NOT_DETECTED = 0,   ///< æœªæ£€æµ‹åˆ°
    NORMAL = 1,         ///< æ­£å¸¸æ£€æµ?
    LOW_CONFIDENCE = 2, ///< ä½ç½®ä¿¡åº¦è­¦å‘Š
    INVALID = 3         ///< æ— æ•ˆ/é”™è¯¯
};

/**
 * @brief 2D ç›´çº¿å‚æ•°ï¼ˆAx + By + C = 0ï¼Œå½’ä¸€åŒ?AÂ²+BÂ²=1ï¼?
 */
struct Line2D {
    float a = 0.0f;  ///< ç›´çº¿ç³»æ•° A
    float b = 0.0f;  ///< ç›´çº¿ç³»æ•° B
    float c = 0.0f;  ///< ç›´çº¿ç³»æ•° C
    
    // ç›´çº¿ç«¯ç‚¹ï¼ˆç”¨äºå¯è§†åŒ–ï¼?
    float x1 = 0.0f, y1 = 0.0f;
    float x2 = 0.0f, y2 = 0.0f;
};

//=============================================================================
// æœ€è¿‘åŒºåŸŸè·ç¦»æ£€æµ?(Nearest Region Distance)
//=============================================================================

/**
 * @brief æœ€è¿‘åŒºåŸŸè·ç¦»æ£€æµ‹é…ç½?
 * 
 * å‚è€ƒç³»è¯´æ˜ï¼?
 * - å½“å‰å®ç°ä»?*é›·è¾¾åæ ‡ç³»åŸç‚?*ä¸ºå‚è€ƒç‚¹
 * - å¦‚æœé›·è¾¾å®‰è£…åœ¨èˆ¹ä¸Šï¼ŒåŸç‚¹å³ä¸ºé›·è¾¾å®‰è£…ä½ç½®
 * - Xè½´æŒ‡å‘å‰æ–¹ï¼ŒYè½´æŒ‡å‘å·¦ä¾§ï¼ŒZè½´å‘ä¸?
 * 
 * æ¨èå‚æ•°å€¼ï¼ˆæ ¹æ®åœºæ™¯è°ƒæ•´ï¼‰ï¼š
 * - sector_x: [0, 50] æ£€æµ‹å‰æ–?0ç±?
 * - sector_y: [-15, 15] å·¦å³å?5ç±?
 * - sector_z: [-1, 10] æ°´é¢ä»¥ä¸Š
 * - percentile: 5-10% ä½¿ç”¨æœ€è¿‘çš„5-10%ç‚?
 * - min_points: 20-50 æœ€å°‘éœ€è¦?0-50ä¸ªç‚¹æ‰è¾“å‡?
 */
struct NearestRegionConfig {
    // æ£€æµ‹æ‰‡åŒºï¼ˆé›·è¾¾åæ ‡ç³»ï¼‰
    float sector_x_min = 0.0f;          ///< Xæœ€å°å€?m)ï¼Œæ¨è?ï¼ˆåªæ£€æµ‹å‰æ–¹ï¼‰
    float sector_x_max = 50.0f;         ///< Xæœ€å¤§å€?m)ï¼Œæ¨è?0-80ï¼ˆæ ¹æ®ç å¤´è·ç¦»ï¼‰
    float sector_y_min = -15.0f;        ///< Yæœ€å°å€?m)ï¼Œæ¨è?10~-20ï¼ˆå³ä¾§èŒƒå›´ï¼‰
    float sector_y_max = 15.0f;         ///< Yæœ€å¤§å€?m)ï¼Œæ¨è?0~20ï¼ˆå·¦ä¾§èŒƒå›´ï¼‰
    float sector_z_min = -1.0f;         ///< Zæœ€å°å€?m)ï¼Œæ¨è?1~0ï¼ˆç•¥ä½äºæ°´é¢ï¼?
    float sector_z_max = 10.0f;         ///< Zæœ€å¤§å€?m)ï¼Œæ¨è?~15ï¼ˆç å¤´é«˜åº¦ï¼‰
    
    // æœ€è¿‘è·ç¦»è®¡ç®—å‚æ•?
    float percentile = 5.0f;            ///< æœ€è¿‘ç‚¹ç™¾åˆ†ä½?%)ï¼Œæ¨è?-10ï¼Œå–æœ€è¿‘N%ç‚¹çš„å¹³å‡
    size_t min_points = 30;             ///< æœ€å°ç‚¹æ•°è¦æ±‚ï¼Œå°‘äºæ­¤æ•°ä¸è¾“å‡?
    
    // è¾“å‡ºå¹³æ»‘
    float smoothing_alpha = 0.3f;       ///< å¹³æ»‘ç³»æ•°(0-1)ï¼Œæ¨è?.2-0.4ï¼Œè¶Šå°è¶Šå¹³æ»‘
    bool enable_smoothing = true;       ///< æ˜¯å¦å¯ç”¨å¹³æ»‘
    
    // å¼€å…?
    bool enabled = true;                ///< æ˜¯å¦å¯ç”¨æ­¤æ£€æµ?
    bool show_sector = true;            ///< æ˜¯å¦æ˜¾ç¤ºæ£€æµ‹æ‰‡åŒºï¼ˆå¯è§†åŒ–ï¼‰
};

/**
 * @brief æœ€è¿‘åŒºåŸŸè·ç¦»æ£€æµ‹ç»“æ?
 */
struct NearestRegionResult {
    bool valid = false;                 ///< æ˜¯å¦æœ‰æ•ˆ
    float distance_m = 0.0f;            ///< æœ€è¿‘åŒºåŸŸè·ç¦?m)
    float nearest_x = 0.0f;             ///< æœ€è¿‘åŒºåŸŸä¸­å¿ƒX
    float nearest_y = 0.0f;             ///< æœ€è¿‘åŒºåŸŸä¸­å¿ƒY
    size_t point_count = 0;             ///< æ‰‡åŒºå†…ç‚¹æ•?
    size_t used_points = 0;             ///< ç”¨äºè®¡ç®—çš„ç‚¹æ•°ï¼ˆpercentileï¼?
    uint8_t confidence = 0;             ///< ç½®ä¿¡åº?0-100
};

//=============================================================================
// ç å¤´è¾¹ç¼˜æ£€æµ?(Dock Edge Detection)
//=============================================================================

/**
 * @brief ç å¤´è¾¹ç¼˜æ£€æµ‹é…ç½?
 * 
 * åŸç†ï¼?
 * - ç å¤´è¾¹ç¼˜æ˜¯ç‰¹å®šé«˜åº¦èŒƒå›´å†…çš„æ°´å¹³çº¿çŠ¶ç»“æ?
 * - é€šè¿‡Zè½´åˆ‡ç‰?RANSACæ‹Ÿåˆç›´çº¿
 * 
 * æ¨èå‚æ•°å€¼ï¼š
 * - edge_z: [0.3, 1.5] ç å¤´è¾¹ç¼˜çš„å…¸å‹é«˜åº?
 * - sector_x: [0, 30] åªæ£€æµ‹è¾ƒè¿‘è·ç¦?
 * - ransac_dist: 0.1-0.2m
 * - min_inlier_ratio: 0.3-0.5
 */
struct DockEdgeConfig {
    // æ£€æµ‹æ‰‡åŒºï¼ˆé›·è¾¾åæ ‡ç³»ï¼‰
    float sector_x_min = 0.0f;          ///< Xæœ€å°å€?m)
    float sector_x_max = 30.0f;         ///< Xæœ€å¤§å€?m)ï¼Œè¾¹ç¼˜æ£€æµ‹èŒƒå›´è¾ƒå°?
    float sector_y_min = -15.0f;        ///< Yæœ€å°å€?m)
    float sector_y_max = 15.0f;         ///< Yæœ€å¤§å€?m)
    
    // ç å¤´è¾¹ç¼˜é«˜åº¦èŒƒå›´ï¼ˆå…³é”®å‚æ•°ï¼ï¼?
    float edge_z_min = 0.3f;            ///< è¾¹ç¼˜Zæœ€å°å€?m)ï¼Œæ¨è?.2-0.5
    float edge_z_max = 1.5f;            ///< è¾¹ç¼˜Zæœ€å¤§å€?m)ï¼Œæ¨è?.0-2.0
    
    // RANSAC å‚æ•°
    float ransac_distance_threshold = 0.15f;  ///< å†…ç‚¹è·ç¦»é˜ˆå€?m)ï¼Œæ¨è?.1-0.2
    int ransac_max_iterations = 200;          ///< æœ€å¤§è¿­ä»£æ¬¡æ•?
    float ransac_min_inlier_ratio = 0.3f;     ///< æœ€å°å†…ç‚¹æ¯”ä¾‹ï¼Œæ¨è0.3-0.5
    size_t min_points = 50;                   ///< æœ€å°ç‚¹æ•°è¦æ±?
    
    // è¾“å‡ºå¹³æ»‘
    float smoothing_alpha = 0.3f;       ///< å¹³æ»‘ç³»æ•°(0-1)
    bool enable_smoothing = true;       ///< æ˜¯å¦å¯ç”¨å¹³æ»‘
    
    // å¼€å…?
    bool enabled = false;               ///< æ˜¯å¦å¯ç”¨æ­¤æ£€æµ‹ï¼ˆé»˜è®¤å…³é—­ï¼?
    bool show_region = true;            ///< æ˜¯å¦æ˜¾ç¤ºæ£€æµ‹åŒºåŸŸï¼ˆå¯è§†åŒ–ï¼‰
};

/**
 * @brief ç å¤´è¾¹ç¼˜æ£€æµ‹ç»“æ?
 */
struct DockEdgeResult {
    bool valid = false;                 ///< æ˜¯å¦æœ‰æ•ˆ
    float distance_m = 0.0f;            ///< åˆ°è¾¹ç¼˜çš„å‚ç›´è·ç¦»(m)
    float angle_deg = 0.0f;             ///< è¾¹ç¼˜ä¸Xè½´çš„å¤¹è§’(åº?
    Line2D edge_line;                   ///< è¾¹ç¼˜ç›´çº¿
    size_t inlier_count = 0;            ///< å†…ç‚¹æ•?
    size_t total_points = 0;            ///< åˆ‡ç‰‡å†…æ€»ç‚¹æ•?
    float mean_error = 0.0f;            ///< å†…ç‚¹å¹³å‡è¯¯å·®
    uint8_t confidence = 0;             ///< ç½®ä¿¡åº?0-100
};

//=============================================================================
// ç»¼åˆé æ³ŠçŠ¶æ€?
//=============================================================================

/**
 * @brief ç»¼åˆé æ³ŠçŠ¶æ€?
 */
struct DockingState {
    uint64_t timestamp_ns = 0;          ///< æ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼?
    
    // æœ€è¿‘åŒºåŸŸæ£€æµ‹ç»“æ?
    NearestRegionResult nearest;
    
    // ç å¤´è¾¹ç¼˜æ£€æµ‹ç»“æ?
    DockEdgeResult edge;
    
    // ç»¼åˆçŠ¶æ€ï¼ˆå–ä¸¤è€…ä¸­æœ‰æ•ˆä¸”è·ç¦»æœ€è¿‘çš„ï¼?
    DockingStatus status = DockingStatus::NOT_DETECTED;
    float final_distance_m = 0.0f;      ///< æœ€ç»ˆè¾“å‡ºè·ç¦?
    float final_angle_deg = 0.0f;       ///< æœ€ç»ˆè¾“å‡ºè§’åº¦ï¼ˆä»…è¾¹ç¼˜æ£€æµ‹æœ‰æ•ˆæ—¶ï¼?
    
    bool is_valid() const {
        return nearest.valid || edge.valid;
    }
};

/**
 * @brief å®Œæ•´é æ³Šé…ç½®
 */
struct DockingConfig {
    NearestRegionConfig nearest;        ///< æœ€è¿‘åŒºåŸŸé…ç½?
    DockEdgeConfig edge;                ///< ç å¤´è¾¹ç¼˜é…ç½®
};

} // namespace Linger
